from bs4 import BeautifulSoup
import requests
import smtplib
import time
import re

def connection():
    URL = 'https://www.worldometers.info/coronavirus/'
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36'
    }

    global page
    global soup
    page = requests.get(URL, headers = headers)
    soup = BeautifulSoup(page.content, 'html.parser')

def get_data():
    global main_data
    main_data = []

    for i in soup.find_all("div", id="maincounter-wrap"):
        heading = i.h1.text
        number = i.div.text
        global body
        body = f"{heading} {number}"
        main_data.append(body + '\n')

    global headings
    headings = []
    global China
    China = []
    global India
    India = []
    global UAE
    UAE = []

    for i in soup.find_all("table", id="main_table_countries_today"):
        for k in i.find_all("th"):
            x = k.text.strip()
            headings.append(x)
        for k in i.find_all("tr"):
            for l in k.find_all("td", text = 'China'):
                x = k.text
                China.append(x)
            for l in k.find_all("td", text = 'India'):
                x = k.text
                India.append(x)
            for l in k.find_all("td", text = 'UAE'):
                x = k.text
                UAE.append(x)

    for i in range(2):                
        for i in China:
            td = i.replace(' ','')
            China.remove(i)
            China.append(td)

    for i in range(2):                
        for i in India:
            td = i.replace(' ','')
            India.remove(i)
            India.append(td)

    for i in range(2):                
        for i in UAE:
            td = i.replace(' ','')
            UAE.remove(i)
            UAE.append(td)

    print(headings)
    print(len(headings))
    print('')
 
    print(China)

    print(India)

    print(UAE)

    remove_n(China)
    remove_n(India)
    remove_n(UAE)

    print('')

    print(China)

    print(India)

    print(UAE) 
    print('')

    final_china = data_dict(headings, China)
    print(final_china)
    final_india = data_dict(headings, India)
    print(final_india)
    final_uae = data_dict(headings, UAE)
    print(final_uae)

    while len(China) > 0:
        for i in China:
            China.remove(i)

    for k, v in final_china.items():
        x = f'{k}: {v}'
        China.append(x)
    China = [i + '\n' for i in China]

    print(China)

    while len(India) > 0:
        for i in India:
            India.remove(i)

    for k, v in final_india.items():
        x = f'{k}: {v}'
        India.append(x)
    India = [i + '\n' for i in India]

    print(India)

    while len(UAE) > 0:
        for i in UAE:
            UAE.remove(i)

    for k, v in final_uae.items():
        x = f'{k}: {v}'
        UAE.append(x)
    UAE = [i + '\n' for i in UAE]

    print(UAE)


def data_dict(head, list):
    final_data = {head[i]: list[i] for i in range(len(head))}
    return final_data   

def listToString(list):  
    
    # initialize an empty string 
    str1 = "" 
    
    # return string   
    return(str1.join(list))  

def remove_n(list):
    list[0].replace('\n\n', '\n \n')

    result = list[0].split("\n")

    print('results')
    print(result)

    list.remove(list[0])

    for i in result:
        list.append(i)

    list.pop(0)
    list.pop(-1)
    list.pop(-2)

    print(list)
    print(len(list))

def send_mail():
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.ehlo()
    server.starttls()
    server.ehlo()

    server.login('suraj.dayma11@gmail.com', 'ilibymfswsahkpkc')

    subject = 'COVID 19 Update'
    
    main_body = listToString(main_data)
    Con1 = listToString(China)
    Con2 = listToString(India)
    Con3 = listToString(UAE)

    body = f"{main_body}\n\n{Con1}\n\n{Con2}\n\n{Con3}"

    msg = f"Subject: {subject}\n\n{body}".encode('utf-8')

    while True:
        server.sendmail(
            'suraj.dayma11@gmail.com',
            'suraj.dayma11@gmail.com',
            msg
        )
        print('EMAIL SENT TO SURAJ')

        time.sleep(60*60)

    server.quit()


def run():
    print('')
    connection()
    get_data()
    send_mail()    

run()
